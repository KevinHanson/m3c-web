<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>M3C Listing</title>

    <!-- Font Awesome for neat icons. -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
        integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">

    <!-- Roboto font -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="m3c.css" />

    <!-- Promise polyfill to support Internet Explorer -->
    <script crossorigin src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"></script>
    <!-- Fetch polyfill to support Internet Explorer -->
    <script crossorigin src="https://unpkg.com/whatwg-fetch@3.0.0/dist/fetch.umd.js"></script>
    <!-- URL polyfill to support Internet Explorer -->
    <script crossorigin src="https://unpkg.com/@ungap/url-search-params@0.1.2/min.js"></script>

</head>

<body class="listing">

    <div class="container">

        <header>
            <a href="https://metabolomics.info/">
                <img alt="Metabolomics Info logo"
                    src="https://i2.wp.com/metabolomics.info/wp-content/uploads/2018/10/sepcc-logo-75.png?fit=60%2C60&ssl=1"
                    width=60 height=60>
                <div class="text">
                    <h1>Metabolomics Info</h1>
                    <p>An international resource for news and events in metabolomics</p>
                </div>
            </a>
            <div class="spacer"></div>
            <a href="index.html" class="dashboard-link">
                <h2>People Portal</h2>
            </a>
        </header>

        <div class="page">
            <h1>People</h1>
            <div id="listing">
                <div class="controls">
                    <a href="#" class="reverse">Reverse</a>
                </div>

                <div class="facets">
                    <div class="facet organization">
                        <p>Organization</p>
                        <ul></ul>
                    </div>
                </div>

                <ol class="results">
                    <!-- Templates aren't visible, but their clones are filled out with real data. -->
                    <li class="person template">
                        <a href="#">
                            <img class="photo" width=64 height=64></img>
                            <div class="name"></div>
                        </a>
                        <div class="organization"></div>
                        <div class="email"></div>
                        <div class="phone"></div>
                    </li>
                </ol>
            </div>
        </div>

        <footer>
            <p>
                Metabolomics Info is an outreach portal to support the
                Metabolomics community.
            </p>
            <p>
                Â© 2019 Metabolomics Consortium Coordinating Center
            </p>
        </footer>


        <!-- Order matters; all dependencies for a module must be loaded first. -->
        <script src="tpf.js"></script>
        <script src="str.js"></script>
        <script src="m3c.js"></script>
        <script src="ui.js"></script>
        <script src="entity.js"></script>

        <script>
            const client = m3c.NewTPFClient()
            const root = document.getElementById("listing")
            const ol = root.querySelector("ol")
            const ctrlReverse = root.querySelector(".reverse")
            const template = root.querySelector("li.person.template")

            const people = {}

            ui.SortedList(ol, ctrlReverse, 1, listItemName)
            entity.Persons(client, renderPerson)

            function increment(facetID, optionID, optionName) {
                const facet = root.querySelector(".facet." + facetID + " ul")
                if (!facet) {
                    return
                }

                var option = facet.querySelector(str.Format('li[data-id="{}"]', optionID))
                if (!option) {
                    option = document.createElement("li")
                    option.setAttribute("data-id", optionID)
                    facet.appendChild(option);
                }

                const checked = option.querySelector("input:checked")
                var count = option.querySelector(".count") || 0
                if (count) {
                    count = parseInt(count.innerText.slice(1, -1)) || 0
                }

                option.innerHTML = str.Format(
                    '<input type="checkbox" value={} {} />' +
                    '<span class="name">{}</span>' +
                    '<span class="count">({})</span>',
                    optionID, checked ? 'checked' : '', optionName, count + 1
                )

                option.querySelector("input")
                    .addEventListener("click", onFacetClick)
            }

            const filters = [
                function organization(selected, li) {
                    const org = li.querySelector(".organization")
                    return selected.indexOf(org.innerText) !== -1
                },
            ]

            function onFacetClick(checkbox) {
                const lis = root.querySelectorAll(".results li")
                const items = []
                for (var i = 0; i < lis.length; i++) {
                    items.push(lis[i])
                }

                const remaining = filters.map(function (filter) {
                    const checked = root.querySelectorAll(".facet." + filter.name + " input:checked")

                    const selected = []
                    for (var i = 0; i < checked.length; i++) {
                        const input = checked[i]
                        const option = input.parentElement
                        const name = option.querySelector(".name")
                        selected.push(name.innerText.trim())
                    }

                    if (selected.length === 0) {
                        return items
                    }

                    const remaining = items.filter(function (item) {
                        return filter(selected, item)
                    })

                    return remaining
                })

                console.log(remaining[0])

                for (var i = 0; i < items.length; i++) {
                    const item = items[i]
                    // TODO: support multiple facets
                    if (remaining[0].indexOf(item) === -1) {
                        if (item.className.indexOf("hidden") === -1) {
                            // If it's not hidden, hide it
                            item.className = (item.className + " hidden").trim()
                        }
                    } else {
                        item.className = item.className.replace("hidden", "")
                    }
                }
            }

            /** Extracts the name of a list item; used for sorting. */
            function listItemName(li) {
                const firstLast = li.querySelector(".name").innerText.toUpperCase()
                const lastFirst = firstLast.split(' ').reverse().join(' ')
                return lastFirst
            }

            function renderPerson(personIRI) {
                personIRI = personIRI.slice(1, -1)
                people[personIRI] = {}
                renderPersonCard(personIRI)
            }

            function renderPersonCard(iri) {
                const li = template.cloneNode(true)
                li.className = li.className.replace("template", "")

                const link = li.querySelector("a")
                link.href = m3c.ProfileLink("person", iri)

                const person = entity.Person(client, iri)
                person.Name(renderName)
                person.Photo(renderPhoto)
                person.Organization(renderOrganization)
                person.Phones(renderPhones)
                person.Emails(renderEmails)

                const placeholder = "https://cdn.pixabay.com/photo/2016/08/08/09/17/avatar-1577909_960_720.png"

                function renderEmails(emails) {
                    if (!emails || emails.length === 0) {
                        return
                    }

                    li.querySelector(".email").innerHTML = str.Format(
                        '<i class="fas fa-envelope"></i>{}',
                        emails[0]
                    )
                }

                function renderName(name) {
                    name = name.trim()
                    people[iri].name = name

                    link.querySelector(".name").innerHTML = name
                    // '<i class="fas fa-user"></i>' + name
                    link.querySelector(".photo").alt = name

                    ol.append(li)
                }

                function renderOrganization(organizationIRI) {
                    organizationIRI = organizationIRI.slice(1, -1)
                    entity.Name(client, organizationIRI, renderOrganizationName)

                    function renderOrganizationName(name) {
                        name = name.trim()
                        people[iri] = organizationIRI

                        increment('organization', organizationIRI, name)

                        li.querySelector(".organization").innerHTML =
                            '<i class="fas fa-building"></i>' + name
                    }
                }

                function renderPhones(telephones) {
                    if (!telephones || telephones.length === 0) {
                        return
                    }

                    li.querySelector(".phone").innerHTML = str.Format(
                        '<i class="fas fa-phone"></i>{}',
                        telephones[0]
                    )
                }

                function renderPhoto(url) {
                    if (!url) {
                        url = placeholder
                    }

                    const img = link.querySelector(".photo")
                    img.src = url
                }
            }
        </script>
    </div>
</body>

</html>